\begin{tikzpicture}[node distance=12pt, auto]
\tikzstyle{system}=[rectangle,
                                draw=blue!80,
                                fill=blue!40,
                                inner sep=0.1cm,
                                rounded corners=10pt,
                                style=dashed,thick]
\tikzstyle{program}=[rectangle,
                                  draw=black,
                                  fill=orange!40,
                                  inner sep=0.1cm,
                                  rounded corners=5pt,
                                  style=thick,
                                  drop shadow]
\tikzstyle{data}=[rectangle,
                            draw=gray!70,
                            fill=gray!30,
                            inner sep=0.1cm,
                            rounded corners=5pt,
                            style=thick]
\node[data] (classes) {Java class files};
\node[data, right=of classes] (properties) {TOPL property files};

\node[below=of classes] (classesd) {};
\node[below=of properties] (propertiesd) {};

\node[program, below=40pt of classes] (instrumenter) {Instrumenter};
\node[program, below=40pt of properties] (genautomaton) {Automaton Generator};

\node[data, below=of genautomaton] (javaproperties) {Property.java};
\node[right=of javaproperties] (javadummy) {};
\node[data, right=of javadummy] (checker) {Checker.java};
\node[program, below=of javadummy] (javac) {Java Compiler};

\node[data, below=of javac] (classproperties) {Checker.class};
\node[left=of classproperties] (classdummy) {};
\node[data, left=of classdummy] (instrclasses) {Instrumented Java class files};
\node[program, below=of classdummy] (jvm) {JVM};

\node[above=5pt] at ($(instrumenter.north)!.5!(genautomaton.north)$) (topllabel) {\emph{TOPL Compiler}};
\node[above=5pt of checker] (checkerlabel) {\emph{Property Checker}};
\begin{pgfonlayer}{background}
  \node[system, fit = (topllabel) (instrumenter) (genautomaton)] (TOPLC) {};
  \node[system, fit = (checker) (checkerlabel)] (CHECKER) {};
\end{pgfonlayer}

\path[ultra thick, ->]
(classes) edge (instrumenter)

(genautomaton) edge (instrumenter)
(instrumenter) edge (genautomaton)

(properties) edge (genautomaton)
(genautomaton)  edge (javaproperties)
(javac) edge (classproperties);

\draw[ultra thick, ->]
(instrumenter) -- ($(instrumenter.south)-(0,40pt)$) -| (instrclasses);
\draw[ultra thick, ->]
(instrclasses) -| ($(jvm.north)-(5pt,0)$);
\draw[ultra thick, ->]
(classproperties) -| ($(jvm.north)+(5pt,0)$);
\draw[ultra thick, ->]
(javaproperties)  -| ($(javac.north)-(5pt,0)$);
\draw[ultra thick, ->]
(checker)  -| ($(javac.north)+(5pt,0)$);
(\end{tikzpicture}
